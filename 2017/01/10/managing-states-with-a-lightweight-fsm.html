<!DOCTYPE html>
<html class="skin-default" lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=450, initial-scale=1">

    <!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Managing states with a lightweight FSM | Lea Hayes</title>
<meta property="og:title" content="Managing states with a lightweight FSM" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Games will typically have a number of states and sub-states and there are endless ways in which these states can be defined from using a switch statement, to using delegates, state pattern, coroutines, scenes, animation events, etc. Each approach brings its own advantages and disadvantages and some are better suited depending on the use case." />
<meta property="og:description" content="Games will typically have a number of states and sub-states and there are endless ways in which these states can be defined from using a switch statement, to using delegates, state pattern, coroutines, scenes, animation events, etc. Each approach brings its own advantages and disadvantages and some are better suited depending on the use case." />
<link rel="canonical" href="/2017/01/10/managing-states-with-a-lightweight-fsm.html" />
<meta property="og:url" content="/2017/01/10/managing-states-with-a-lightweight-fsm.html" />
<meta property="og:site_name" content="Lea Hayes" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-01-10T00:00:00+00:00" />
<script type="application/ld+json">
{"name":null,"description":"Games will typically have a number of states and sub-states and there are endless ways in which these states can be defined from using a switch statement, to using delegates, state pattern, coroutines, scenes, animation events, etc. Each approach brings its own advantages and disadvantages and some are better suited depending on the use case.","author":null,"@type":"BlogPosting","url":"/2017/01/10/managing-states-with-a-lightweight-fsm.html","publisher":null,"image":null,"headline":"Managing states with a lightweight FSM","dateModified":"2017-01-10T00:00:00+00:00","datePublished":"2017-01-10T00:00:00+00:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"/2017/01/10/managing-states-with-a-lightweight-fsm.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/main.css">
    <link rel="alternate" type="application/rss+xml" title="Lea Hayes" href="/feed.xml">

    
  </head>
  <body>

    <header class="site-header" role="banner">
  <div class="site-header__wrap">
    <a class="site-badge" href="/">Lea Hayes</a>

    <nav class="site-nav">
  <ul class="site-nav__list">
  
    
    
    <li class="site-nav__item">
      <a class="site-nav__link" href="/about/">About</a>
    </li>
    
  
    
    
    <li class="site-nav__item">
      <a class="site-nav__link" href="/portfolio/">Portfolio</a>
    </li>
    
  
    
    
    <li class="site-nav__item">
      <a class="site-nav__link" href="/blog/index.html">Blog</a>
    </li>
    
  
  </ul>
</nav>

  </div>
</header>


    <main class="main-content" aria-label="Content">
      <div class="main-content__wrap">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <nav class="blog-nav">
  <h1 class="blog-nav__title">Blog Navigation</h1>
  <ul class="blog-nav__list blog-nav__list--primary">
    <li class="blog-nav__item"><a class="blog-nav__link" href="/blog/">Posts</a></li>
    <li class="blog-nav__item"><a class="blog-nav__link" href="/tags/">Tags</a></li>
  </ul>
  <ul class="blog-nav__list blog-nav__list--secondary">
    <li class="blog-nav__item blog-nav__item--rss"><a class="blog-nav__link" href="/feed.xml">Subscribe via RSS</a></li>
  </ul>
</nav>


  <header class="post__header">
    <h1 class="post__title" itemprop="name headline">Managing states with a lightweight FSM</h1>
    <p class="post__meta">
      <time datetime="2017-01-10T00:00:00+00:00" itemprop="datePublished">
        
        Jan 10, 2017
      </time>
    </p>
  </header>

  <div class="post__content body-content" itemprop="articleBody">
    <p>Games will typically have a number of states and sub-states and there are endless ways in
which these states can be defined from using a switch statement, to using delegates, state
pattern, coroutines, scenes, animation events, etc. Each approach brings its own
advantages and disadvantages and some are better suited depending on the use case.</p>

<p><img src="/assets/blog/2017/01/10/examples.png" alt="Examples of state machines" /></p>

<p>One thing that I will say is that relying on animation events can be quite unpredictable
since sometimes they do not trigger. In a client project we found that Unity’s animation
system skips over animation events when there is a spike in the framerate. This was really
bad because randomly it would not advance to the next stage.</p>

<p>Unity actually includes a state machine called Mechanim which was designed primarily to
manage the states of animations although can be used as a general purpose state machine by
implementing state behavior classes. Despite being a powerful system for animation it
seems to lack some of the flexibility and simplicity that I require from a general purpose
state machine.</p>

<p>The design of my general purpose state machine has evolved over past projects. Each state
machine instance is started as a long running coroutine which is extremely useful when
defining procedural animation and time-based events. It works very well with the <a href="http://dotween.demigiant.com/">DOTween</a>
tweening library that I use. Transitions can optionally be specified to manage the
transition from one state to another; this is useful when adding fancy screen transitions.</p>

<p>Coroutine performance has gotten a lot better in recent releases of Unity. Obviously they
still come at a relatively small cost but they are a useful tool and the advantages of
using them for my use cases far outweigh that cost.</p>

<p>My lightweight fsm implementation will work in any regular .NET / Mono application since
it makes minimal usage of the Unity API. The only Unity-specific class is the
<code class="highlighter-rouge">StateComponent</code> base class which is completely ignored when used outside of the Unity
engine.</p>

<p><img src="/assets/blog/2017/01/10/overview-fsm.png" alt="Projects and Packages" /></p>

<p>State transitions can be initiated by specifying either the target <code class="highlighter-rouge">IState</code> or the name of
the target state. For this reason it is useful to be able to resolve the <code class="highlighter-rouge">IState</code> of a
given name even allowing for more complex state resolution logic if desired. For example,
a more complex state resolver could select between multiple “TitleMenu” states based upon
whether the game has been completed or some in-app-purchase has been purchased.</p>

<p>Likewise it is useful to be able to resolve the transition that should be used when
transitioning from one state to another. A transition is an optional object that can
sequence the transition from the current state to the next. This can be useful when
adding fancy transitions between screens.</p>

<p>My <code class="highlighter-rouge">StateMachine&lt;TStateName&gt;</code> class can be constructed by providing a state resolver and
a transition resolver or alternatively a state graph. A state graph is simply an object
that provides both state and transition resolution logic. A basic <code class="highlighter-rouge">StateGraph&lt;TStateName&gt;</code>
implementation is provided which allows states and transitions to be registered but
obviously it is possible to use an entirely custom implementation.</p>

<p><img src="/assets/blog/2017/01/10/overview-graph.png" alt="Projects and Packages" /></p>

<p>In my projects I use this state machine library in various different ways. I have two base
classes <code class="highlighter-rouge">State</code> and <code class="highlighter-rouge">StateComponent</code> which can be used to implement states as POCOs or
as components that can be attached to game objects.</p>

<p>I also made a reusable <code class="highlighter-rouge">EmptyState</code> sealed class which is a singleton that does nothing.
This state can be used when states have no special functionality or when blocking out new
state machines.</p>

<p><img src="/assets/blog/2017/01/10/overview-state.png" alt="Projects and Packages" /></p>

<p>Each state of a <code class="highlighter-rouge">IStateMachine&lt;TStateName&gt;</code> is identified using a name that is defined
using an enum. This is then used as the generic type parameter when constructing a state
machine.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">enum</span> <span class="n">GameStateName</span>
<span class="p">{</span>
    <span class="n">Intro</span><span class="p">,</span>
    <span class="n">TitleMenu</span><span class="p">,</span>
    <span class="n">Playing</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I like to expose each state to the world by providing a context object; but this is
entirely optional. A context can optionally implement the <code class="highlighter-rouge">IStateContext&lt;GameStateName&gt;</code>
interface which provides some useful methods to transition to the next state. Additional
transition logic can of course be added to the context where needed (such as to exit to
the desktop).</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IGameStateContext</span> <span class="p">:</span> <span class="n">IStateContext</span><span class="p">&lt;</span><span class="n">GameStateName</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">void</span> <span class="nf">ExitGame</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The context object can be provided to the state in a number of ways including constructor
injection, property injection or via some sort of <code class="highlighter-rouge">Initialize</code> method. I like to put this
common logic into an abstract base class:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">GameState</span> <span class="p">:</span> <span class="n">State</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">IGameStateContext</span> <span class="n">Context</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the following example I have a <code class="highlighter-rouge">GameController</code> which is essentially just a navigation
controller that navigates the main states of the game. Each of these states can define
sub-states if they need to be broken down further. For example, depending on the type of
game the “Playing” state could be broken down into various sub-states such as “Prepare”,
“Standard” and “GameOver”.</p>

<p>With this particular example each game state is essentially a presenter which populates
the properties and observes the events of an associated view (essentially the MVP design
pattern). I use dependency injection to instantiate the object hierarchy but any object
creation method can of course be used.</p>

<p>In this case the <code class="highlighter-rouge">GameController</code> acts as the context of its states. If preferred the
context can be encapsulated by implementing a private <code class="highlighter-rouge">GameController.Context</code> class;
although I don’t feel that the extra level of indirection adds any real value here.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">GameController</span> <span class="p">:</span> <span class="n">IGameStateContext</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">StateMachine</span><span class="p">&lt;</span><span class="n">GameStateName</span><span class="p">&gt;</span> <span class="n">stateMachine</span><span class="p">;</span>


    <span class="c1">// Dependencies are injected into the constructor.</span>
    <span class="k">public</span> <span class="nf">GameController</span><span class="p">(</span>
        <span class="n">IntroGameState</span> <span class="n">introState</span><span class="p">,</span>
        <span class="n">TitleMenuGameState</span> <span class="n">titleMenuState</span><span class="p">,</span>
        <span class="n">PlayingGameState</span> <span class="n">playingState</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Assign context to each of the states.</span>
        <span class="n">introState</span><span class="p">.</span><span class="n">Context</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="n">titleMenuState</span><span class="p">.</span><span class="n">Context</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="n">playingState</span><span class="p">.</span><span class="n">Context</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span>

        <span class="c1">// Associate each state name with their instances.</span>
        <span class="kt">var</span> <span class="n">graph</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StateGraph</span><span class="p">&lt;</span><span class="n">GameStateName</span><span class="p">&gt;();</span>
        <span class="n">graph</span><span class="p">.</span><span class="nf">RegisterState</span><span class="p">(</span><span class="n">GameStateName</span><span class="p">.</span><span class="n">Intro</span><span class="p">,</span> <span class="n">introState</span><span class="p">);</span>
        <span class="n">graph</span><span class="p">.</span><span class="nf">RegisterState</span><span class="p">(</span><span class="n">GameStateName</span><span class="p">.</span><span class="n">TitleMenu</span><span class="p">,</span> <span class="n">titleMenuState</span><span class="p">);</span>
        <span class="n">graph</span><span class="p">.</span><span class="nf">RegisterState</span><span class="p">(</span><span class="n">GameStateName</span><span class="p">.</span><span class="n">Playing</span><span class="p">,</span> <span class="n">playingState</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">stateMachine</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StateMachine</span><span class="p">&lt;</span><span class="n">GameStateName</span><span class="p">&gt;(</span><span class="n">graph</span><span class="p">);</span>
    <span class="p">}</span>


    <span class="k">public</span> <span class="n">IEnumerator</span> <span class="nf">Execute</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Execute the state machine starting with the intro state.</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">stateMachine</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">GameStateName</span><span class="p">.</span><span class="n">Intro</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">ExitGame</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Application</span><span class="p">.</span><span class="nf">Quit</span><span class="p">();</span>
    <span class="p">}</span>


    <span class="c1">// A little boilerplate to allow states to transition between one another</span>
    <span class="c1">// since `IGameStateContext` implements the `IStateContext&lt;GameStateName&gt;`.</span>
    <span class="k">void</span> <span class="n">IStateContext</span><span class="p">&lt;</span><span class="n">GameStateName</span><span class="p">&gt;.</span><span class="nf">ExitTo</span><span class="p">(</span><span class="n">GameStateName</span> <span class="n">stateName</span><span class="p">,</span> <span class="n">IState</span> <span class="n">state</span><span class="p">,</span> <span class="n">IStateTransition</span> <span class="n">transition</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">stateMachine</span><span class="p">.</span><span class="nf">ExitTo</span><span class="p">(</span><span class="n">stateName</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">transition</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="n">IStateContext</span><span class="p">&lt;</span><span class="n">GameStateName</span><span class="p">&gt;.</span><span class="nf">ExitTo</span><span class="p">(</span><span class="n">GameStateName</span> <span class="n">stateName</span><span class="p">,</span> <span class="n">IState</span> <span class="n">state</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">stateMachine</span><span class="p">.</span><span class="nf">ExitTo</span><span class="p">(</span><span class="n">stateName</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="n">IStateContext</span><span class="p">&lt;</span><span class="n">GameStateName</span><span class="p">&gt;.</span><span class="nf">ExitTo</span><span class="p">(</span><span class="n">GameStateName</span> <span class="n">stateName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">stateMachine</span><span class="p">.</span><span class="nf">ExitTo</span><span class="p">(</span><span class="n">stateName</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Transitions can be explicitly defined on the state graph using <code class="highlighter-rouge">graph.RegisterTransition</code>
when custom transition behavior is desired. With this design it is not necessary to define
which transitions are legal on the graph since each state is responsible for selecting the
state that it would like to exit to. However, state transition validation can easily be
added to a custom state machine implementation if desired.</p>

<p>Here is a very basic “Intro” game state which waits for two seconds before advancing to
the “TitleMenu”. The associated view is shown upon entering the state and then hidden upon
exiting to the next state.</p>

<p>For small games I like to define a “MenuSystem” prefab that contains all of the menu
panels and huds. The root-most object has a “MenuSystem” component that implements a
<code class="highlighter-rouge">IMenuSystem</code> interface providing access to each of the views.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">IntroGameState</span> <span class="p">:</span> <span class="n">GameState</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IIntroView</span> <span class="n">view</span><span class="p">;</span>


    <span class="k">public</span> <span class="nf">IntroGameState</span><span class="p">(</span>
        <span class="n">IMenuSystem</span> <span class="n">menuSystem</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">view</span> <span class="p">=</span> <span class="n">menuSystem</span><span class="p">.</span><span class="n">IntroView</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnEntering</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Show view upon entering state.</span>
        <span class="k">this</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">Show</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="n">IEnumerator</span> <span class="nf">OnExecute</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Wait for a couple of seconds and then exit to the title menu.</span>
        <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="nf">WaitForSeconds</span><span class="p">(</span><span class="m">2f</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">ExitTo</span><span class="p">(</span><span class="n">GameStateName</span><span class="p">.</span><span class="n">TitleMenu</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnExiting</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Hide view upon exiting state.</span>
        <span class="k">this</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">Hide</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the following situation the game state subscribes to a couple of actions from its
view’s interface so that it can start a new game or exit to the desktop. It is useful to
subscribe to these events when entering the state and then to unsubscribe again when
exiting the state so that events are only handled whilst the state is active.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">TitleMenuGameState</span> <span class="p">:</span> <span class="n">GameState</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ITitleMenuView</span> <span class="n">view</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IPlayerProfile</span> <span class="n">playerProfile</span><span class="p">;</span>


    <span class="k">public</span> <span class="nf">TitleMenuGameState</span><span class="p">(</span>
        <span class="n">IMenuSystem</span> <span class="n">menuSystem</span><span class="p">,</span>
        <span class="n">IPlayerProfile</span> <span class="n">playerProfile</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">view</span> <span class="p">=</span> <span class="n">menuSystem</span><span class="p">.</span><span class="n">TitleMenuView</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">playerProfile</span> <span class="p">=</span> <span class="n">playerProfile</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnEntering</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Initialize view from player profile.</span>
        <span class="k">this</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">BestScore</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">playerProfile</span><span class="p">.</span><span class="n">BestScore</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">PreviousScore</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">playerProfile</span><span class="p">.</span><span class="n">PreviousScore</span><span class="p">;</span>

        <span class="c1">// Subscribe to the view's input events.</span>
        <span class="k">this</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">PlayGameAction</span> <span class="p">+=</span> <span class="k">this</span><span class="p">.</span><span class="n">View_PlayGameAction</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">ExitGameAction</span> <span class="p">+=</span> <span class="k">this</span><span class="p">.</span><span class="n">View_ExitGameAction</span><span class="p">;</span>

        <span class="c1">// Show the title menu view.</span>
        <span class="k">this</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">Show</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnExiting</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Be sure to unsubscribe from the view's events again:</span>
        <span class="c1">// - Ignore further input (i.e. button click during hide animation).</span>
        <span class="c1">// - The view might be reused.</span>
        <span class="k">this</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">PlayGameAction</span> <span class="p">-=</span> <span class="k">this</span><span class="p">.</span><span class="n">View_PlayGameAction</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">ExitGameAction</span> <span class="p">-=</span> <span class="k">this</span><span class="p">.</span><span class="n">View_ExitGameAction</span><span class="p">;</span>

        <span class="c1">// Hide the title menu view again.</span>
        <span class="k">this</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">Hide</span><span class="p">();</span>
    <span class="p">}</span>


    <span class="k">private</span> <span class="k">void</span> <span class="nf">View_PlayGameAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Exit to the playing state when the view indicates that the player</span>
        <span class="c1">// would like to play a new game; for instance, by clicking the</span>
        <span class="c1">// "Play Game" button.</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="nf">ExitTo</span><span class="p">(</span><span class="n">GameStateName</span><span class="p">.</span><span class="n">Playing</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">View_ExitGameAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Exit the game when the view indicates that the player would like</span>
        <span class="c1">// to; for instance, by clicking the "Exit Game" button or by pressing</span>
        <span class="c1">// the escape key.</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="nf">ExitGame</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the above examples I demonstrated how I use a state machine to manage high level game
states; but the same mechanism can also be used to manage states elsewhere such as for an
actor.</p>

<p>In the following example the spider actor has four states that are implemented as
components so that they can be attached to the actor game object (or on nested game
objects). The states are then wired up using the inspector. This is a powerful mechanism
because it allows for a “SuperEvilSpider” prefab to be created that has, for example, an
alternative extra mean “Attack” state.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">SpiderActor</span> <span class="p">:</span> <span class="n">MonoBehaviour</span><span class="p">,</span> <span class="n">ISpiderStateContext</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
    <span class="k">private</span> <span class="n">SpiderState</span> <span class="n">idleState</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
    <span class="k">private</span> <span class="n">SpiderState</span> <span class="n">wanderState</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
    <span class="k">private</span> <span class="n">SpiderState</span> <span class="n">attackState</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
    <span class="k">private</span> <span class="n">SpiderState</span> <span class="n">deathState</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>


    <span class="k">private</span> <span class="n">StateMachine</span><span class="p">&lt;</span><span class="n">SpiderStateName</span><span class="p">&gt;</span> <span class="n">stateMachine</span><span class="p">;</span>


    <span class="k">private</span> <span class="k">void</span> <span class="nf">Awake</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">InitializeStates</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">ExecuteStateMachine</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">InitializeStates</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Assert that components were specified for each of the states.</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">IsNotNull</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">idleState</span><span class="p">);</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">IsNotNull</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">wanderState</span><span class="p">);</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">IsNotNull</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">attackState</span><span class="p">);</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">IsNotNull</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">deathState</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">graph</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StateGraph</span><span class="p">&lt;</span><span class="n">SpiderStateName</span><span class="p">&gt;();</span>
        <span class="n">graph</span><span class="p">.</span><span class="nf">RegisterState</span><span class="p">(</span><span class="n">SpiderStateName</span><span class="p">.</span><span class="n">Idle</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">idleState</span><span class="p">);</span>
        <span class="n">graph</span><span class="p">.</span><span class="nf">RegisterState</span><span class="p">(</span><span class="n">SpiderStateName</span><span class="p">.</span><span class="n">Wander</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">wanderState</span><span class="p">);</span>
        <span class="n">graph</span><span class="p">.</span><span class="nf">RegisterState</span><span class="p">(</span><span class="n">SpiderStateName</span><span class="p">.</span><span class="n">Attack</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">attackState</span><span class="p">);</span>
        <span class="n">graph</span><span class="p">.</span><span class="nf">RegisterState</span><span class="p">(</span><span class="n">SpiderStateName</span><span class="p">.</span><span class="n">Death</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">deathState</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">stateMachine</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StateMachine</span><span class="p">&lt;</span><span class="n">SpiderStateName</span><span class="p">&gt;(</span><span class="n">graph</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="n">idleState</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">wanderState</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">attackState</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">deathState</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">ExecuteStateMachine</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">StartCoroutine</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">stateMachine</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">SpiderStateName</span><span class="p">.</span><span class="n">Idle</span><span class="p">));</span>
    <span class="p">}</span>


    <span class="c1">//!TODO: Implement something interesting!</span>
<span class="p">}</span>
</code></pre></div></div>

<p>For this example I chose to use an <code class="highlighter-rouge">Initialize</code> method to initialize the actor with its
context and allowing it to perform additional initialization logic using that context.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">SpiderState</span> <span class="p">:</span> <span class="n">StateComponent</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">ISpiderStateContext</span> <span class="n">Context</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>


    <span class="k">public</span> <span class="k">void</span> <span class="nf">Initialize</span><span class="p">(</span><span class="n">ISpiderStateContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">IsNull</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Context</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Context</span> <span class="p">=</span> <span class="n">context</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">OnInitialize</span><span class="p">();</span>
    <span class="p">}</span>


    <span class="k">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">OnInitialize</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Each spider state is then just an implementation of <code class="highlighter-rouge">SpiderState</code>:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">SpiderState_Attack</span> <span class="p">:</span> <span class="n">SpiderState</span>
<span class="p">{</span>
    <span class="c1">//!TODO: Implement something interesting!</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">SpiderState_ExtraMeanAttack</span> <span class="p">:</span> <span class="n">SpiderState</span>
<span class="p">{</span>
    <span class="c1">//!TODO: Implement something interesting!</span>
<span class="p">}</span>
</code></pre></div></div>


  </div>

  
</article>

<nav class="post-meta-tags">
  <h1 class="post-meta-tags__title">Tags:</h1>
  <ul class="post-meta-tags__list">
  
  
    <li class="post-meta-tags__item"><a class="post-meta-tags__link" href="/tag/csharp">csharp</a></li>
    <li class="post-meta-tags__item"><a class="post-meta-tags__link" href="/tag/dotnet">dotnet</a></li>
    <li class="post-meta-tags__item"><a class="post-meta-tags__link" href="/tag/mono">mono</a></li>
    <li class="post-meta-tags__item"><a class="post-meta-tags__link" href="/tag/unity">unity</a></li>
  </ul>
</nav>


      </div>
    </main>

    <footer class="site-footer">
  <div class="site-footer__wrap">
    <h1 class="site-footer__title">Lea Hayes</h1>

    <div class="site-footer_columns">
      <div class="site-footer__column site-footer__column--social">
        <ul class="social-media-list">

  
  <li class="social-media-list__item">
    <a title="Twitter Profile" target="_blank" href="https://twitter.com/leahayes"><span class="icon icon--twitter"><svg class="svg-icon" xmlns="http://www.w3.org/2000/svg"><use xlink:href="/assets/icons.svg#twitter"></use></svg></span><span class="username">leahayes</span></a>
  </li>
  

  
  <li class="social-media-list__item">
    <a title="Github Profile" target="_blank" href="https://github.com/kruncher"><span class="icon icon--github"><svg class="svg-icon" xmlns="http://www.w3.org/2000/svg"><use xlink:href="/assets/icons.svg#github"></use></svg></span><span class="username">kruncher</span></a>
  </li>
  

  
  <li class="social-media-list__item">
    <a title="LinkedIn Profile" target="_blank" href="https://www.linkedin.com/in/lea-hayes"><span class="icon icon--linkedin"><svg class="svg-icon" xmlns="http://www.w3.org/2000/svg"><use xlink:href="/assets/icons.svg#linkedin"></use></svg></span><span class="username">lea-hayes</span></a>
  </li>
  

</ul>

      </div>

      <div class="site-footer__column site-footer__column--description">
        <p>Welcome to my personal domain where you can find my blog and take a look at some of the projects that I&#39;ve worked on.</p>
      </div>
    </div>

    <small class="site-footer__copyright">©2009-2018 Lea Hayes. All rights reserved.</small>
  </div>
</footer>



    <script src="/assets/js/gallery.js"></script>
  </body>
</html>
